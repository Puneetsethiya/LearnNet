<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LearnNet Course</title>

<link rel="stylesheet" href="responsive.css">

<style>

*{box-sizing:border-box;}

html,body{
margin:0;
padding:0;
width:100%;
overflow-x:hidden;
font-family:'Segoe UI',sans-serif;
background:#f5f5f5;
}

/* ================= DESKTOP ================= */

body{
display:flex;
}

/* SIDE NAV */

.navbar{
background:#2c3e50;
color:white;
width:60px;
height:100vh;
position:fixed;
display:flex;
flex-direction:column;
align-items:center;
padding-top:20px;
font-size:1.2em;
font-weight:bold;
z-index:100;
}

.navbar-text{
writing-mode:vertical-rl;
transform:rotate(180deg);
white-space:nowrap;
}

/* MOBILE TOGGLE */

.playlist-toggle{
display:none;
font-size:26px;
cursor:pointer;
color:white;
margin-top:12px;
}

/* MAIN */

.course-container{
display:flex;
margin-left:60px;
width:calc(100% - 60px);
min-height:100vh;
}

/* PLAYLIST */

.sidebar{
width:280px;
background:#34495e;
color:white;
padding:20px;
overflow-y:auto;
}

/* BACK */

.back-btn{
  width:100%;
  margin-bottom:10px;
  padding:10px 10px;        /* smaller height */
  background:#1abc9c;
  border:none;
  color:white;
  font-size:.85rem;       /* smaller text */
  border-radius:5px;
  cursor:pointer;
  transition:.3s;
}

.back-btn:hover{
  background:#16a085;
}


/* LESSONS */

.lesson{
margin:15px 0;
cursor:pointer;
padding:10px;
border-radius:5px;
background:#2c3e50;
list-style:none;
}

.lesson:hover{
background:#1abc9c;
}

.lesson.completed{
background:#27ae60;
}

.lesson.completed::after{
content:' ✓';
font-weight:bold;
}

/* CONTENT */

.content{
flex:1;
padding:30px;
display:flex;
flex-direction:column;
align-items:center;
}

.video-container{
width:100%;
max-width:800px;
}

iframe{
width:100%;
height:450px;
border:none;
border-radius:10px;
}

.video-title{
margin:10px 0;
font-size:1.3em;
text-align:center;
}

/* NOTES */

.notes-section{
width:100%;
max-width:800px;
background:#fff;
padding:20px;
border-radius:10px;
margin-top:15px;
box-shadow:0 2px 5px rgba(0,0,0,.1);
}

textarea{
width:100%;
height:150px;
border:1px solid #ddd;
border-radius:5px;
padding:10px;
resize:vertical;
}

/* ================= MOBILE ================= */

@media(max-width:900px){

body{
display:block;
}

/* TOP BAR */

.navbar{
width:100%;
height:auto;
position:relative;
flex-direction:row;
justify-content:space-between;
align-items:center;
padding:12px 16px;
}

.navbar-text{
writing-mode:unset;
transform:none;
}

/* SHOW HAMBURGER */

.playlist-toggle{
display:block;
}

/* STACK */

.course-container{
margin-left:0;
width:100%;
flex-direction:column;
}

/* COLLAPSE PLAYLIST */

.sidebar{
display:none;
width:100%;
}

.sidebar.mobile-open{
display:block;
}

/* CONTENT */

.content{
padding:20px;
}

iframe{
height:260px;
}

}

@media(max-width:480px){

iframe{
height:200px;
}

}

</style>
</head>

<body>

<!-- NAVBAR -->
<div class="navbar">

  <div class="navbar-text" id="courseTitle">LearnNet</div>

  <div class="playlist-toggle" onclick="togglePlaylist()">☰</div>

</div>

<div class="course-container">

  <!-- PLAYLIST -->
  <div class="sidebar" id="playlist">

    <h3>Playlist</h3>

    <button class="back-btn" onclick="goBack()">⬅ Back to Courses</button>

    <ul id="lessonList"></ul>

  </div>

  <!-- CONTENT -->
  <div class="content">

    <div class="video-container">
      <iframe id="video-frame" allowfullscreen></iframe>
      <div class="video-title" id="videoTitle"></div>
    </div>

    <div class="notes-section">
      <h3>Notes</h3>
      <textarea placeholder="Write your notes here..."></textarea>
    </div>

  </div>

</div>

<script>

/* ================= TOGGLE PLAYLIST ================= */

function togglePlaylist(){
  document.getElementById("playlist")
    .classList.toggle("mobile-open");
}

/* ================= LOAD VIDEO ================= */

async function loadVideo(videoId,title,index){

  document.getElementById("video-frame").src =
    "https://www.youtube.com/embed/" + videoId;

  document.getElementById("videoTitle").innerText = title;

  const lessonItems=document.querySelectorAll(".lesson");
  if(lessonItems[index]){
    lessonItems[index].classList.add("completed");
  }

  const username=localStorage.getItem("username");
  const params=new URLSearchParams(window.location.search);
  const courseName=params.get("name");

  if(username){
    try{
      const response=await fetch("/user/completion",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({
          username,
          courseName,
          lessonIndex:index
        })
      });

      const data=await response.json();

      if(!response.ok){
        console.log("Completion save failed",data);
      }
    }catch(err){
      console.log("Error saving completion");
    }
  }
}

/* ================= LOAD COURSE ================= */

async function loadCourse(){

  const params=new URLSearchParams(window.location.search);
  const courseName=params.get("name");

  try{

    const res=await fetch(
      "/api/course/" + encodeURIComponent(courseName)
    );

    const course=await res.json();

    if(!course){
      alert("Course not found!");
      return;
    }

    document.getElementById("courseTitle").innerText =
      "LearnNet - " + course.name;

    const list=document.getElementById("lessonList");
    list.innerHTML="";

    let completed=[];
    const username=localStorage.getItem("username");

    if(username){
      try{
        const completionRes=await fetch(
          `/user/completion/${username}/${courseName}`
        );
        const completionData=await completionRes.json();
        completed=completionData.completed || [];
      }catch(err){
        console.log("Could not fetch completion");
      }
    }

    course.parts.forEach((part,index)=>{

      const li=document.createElement("li");
      li.className="lesson";
      li.innerText=part.title;

      if(completed.includes(index)){
        li.classList.add("completed");
      }

      li.onclick=()=>{
        loadVideo(part.youtubeId,part.title,index);

        if(window.innerWidth<=900){
          togglePlaylist(); // auto close on mobile
        }
      };

      list.appendChild(li);

    });

    /* AUTO LOAD FIRST VIDEO */

    if(course.parts.length>0){
      loadVideo(course.parts[0].youtubeId,course.parts[0].title,0);
    }

  }catch(err){
    alert("Failed to load course from cloud");
  }
}

/* ================= BACK ================= */

function goBack(){
  window.location.href="courses.html";
}

/* INIT */

loadCourse();

</script>

<script src="chatbot-inject.js"></script>

</body>
</html>
